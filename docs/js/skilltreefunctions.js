var c_maxlevel=60;function SkillTreeCore(){this._spleft=this._investedsp=this._currentlevel=this._totalsp=0;this.slotassign=new SlotGrid}SkillTreeCore.prototype.GetTotalSP=function(){return this._totalsp};SkillTreeCore.prototype.GetCurrentLevel=function(){return this._currentlevel};SkillTreeCore.prototype.GetInvestedSP=function(){return this._investedsp};SkillTreeCore.prototype.GetSPLeft=function(){return this._spleft};
SkillTreeCore.prototype.SetLevel=function(e){this._currentlevel=Math.min(e,window.c_maxlevel);this._totalsp=this.inner_gettotalsp(this._currentlevel);this.UpdateAllSPs()};SkillTreeCore.prototype.SetLevelFromElement=function(){this.SetLevel(parseInt($("#selectLevelBox").val()))};
SkillTreeCore.prototype.UpdateSP=function(){this._spleft=this._totalsp-this._investedsp;5>this._spleft?$("#e_remainingSP").addClass("alertlow"):$("#e_remainingSP").removeClass("alertlow");$("#e_investedSP").text("Invested SP: "+this._investedsp+"/"+this._totalsp);$("#e_remainingSP").text("Remaining SP: "+this._spleft+"/"+this._totalsp);$("#spusageinfo").html(this.GenerateUsageInfo())};
SkillTreeCore.prototype.UpdateAllSPs=function(){$("#e_investedSP").text("Invested SP: "+this._investedsp+"/"+this._totalsp);this.CheckAllSkills()&&(this._spleft=this._totalsp-this._investedsp,$("#e_remainingSP").text("Remaining SP: "+this._spleft+"/"+this._totalsp),this.CheckAllSkills(),5>this._spleft?$("#e_remainingSP").addClass("alertlow"):$("#e_remainingSP").removeClass("alertlow"));$("#spusageinfo").html(this.GenerateUsageInfo())};SkillTreeCore.prototype.UnlearnAllSkills=function(){for(var e in this.SkillList)this.SkillList[e].UnlearnSkill()};
SkillTreeCore.prototype.CheckAllSkills=function(){if(this._totalsp<this._investedsp){if(this.SkillList)for(var e in this.SkillList)this.SkillList[e].UnlearnSkill();return!1}if(!this.SkillList)return!1;for(e in this.SkillList){var d=this.SkillList[e];if(d.GetAvailableLevel()>this._currentlevel)d.UnlearnSkill();else{d.GetCurrentSkillLevel()<d.GetDefaultLevel()&&d.UnlearnSkill();var c=d.CurrentLevelInfo();c.RequiredLevel>this._currentlevel&&d.UnlearnSkill()}}return!0};
SkillTreeCore.prototype.inner_gettotalsp=function(e){for(var d=0,c=1;c<=e;c++)d+=this.inner_gettotalspex(c);return d};
SkillTreeCore.prototype.inner_gettotalspex=function(e){switch(e){case 0:return 0;case 1:return 0;case 2:return 0;case 3:return 0;case 4:return 1;case 5:return 3;case 6:return 1;case 7:return 1;case 8:return 1;case 9:return 1;case 10:return 5;case 15:return 5;case 20:return 10;case 25:return 5;case 30:return 5;case 35:return 5;case 40:return 10;case 45:return 5;case 50:return 5;case 55:return 5;case 60:return 5;default:return 2}};
SkillTreeCore.prototype.GenerateLink=function(e){var d=[];this._currentlevel!==window.c_maxlevel&&d.push("lv="+this._currentlevel);for(var c in this.SkillList){var a=this.SkillList[c].GetCurrentSkillLevel();a!=this.SkillList[c].GetDefaultLevel()&&(this.SkillList[c].ShortID?d.push(this.SkillList[c].ShortID+"="+a):d.push(c+"="+a))}c=location.protocol+"//"+location.host+location.pathname;a=null;var b=this.slotassign.GenerateAssignment();b&&d.push("s="+b);"2_1"!==this.slotassign.effect2nd&&d.push("b1="+
this.slotassign.effect2nd);"3_1"!==this.slotassign.effect3rd&&d.push("b2="+this.slotassign.effect3rd);!0===e&&d.push("sa=1");1<d.length?a=d.join("&"):1===d.length&&(a=d[0]);a&&(c=c+"?"+a);return c};
SkillTreeCore.prototype.GenerateUsageInfo=function(){var e={},d;for(d in this.SkillList)if(this.SkillList.hasOwnProperty(d)&&this.SkillList[d].GetCurrentSkillLevel()!=this.SkillList[d].GetDefaultLevel()){var c=this.SkillList[d].GetSPUsed();var a=this.SkillList[d].GetParent();0!=c&&(a?e[a.GetID()]+=" + "+c+"SP":e[d]=this.SkillList[d].GetName()+": "+c+"SP")}a="";c=!0;if(0<Object.keys(e).length)for(d in e)e.hasOwnProperty(d)&&(c?(a+=e[d],c=!1):a+="<br>"+e[d]);return a};
SkillTreeCore.prototype.ResetSlotAssignment=function(){this.slotassign.ResetToEmpty()};SkillTreeCore.prototype.SetSkillAssignment=function(e,d,c){this.slotassign.SetGridValue(e,d,c)};SkillTreeCore.prototype.GetSkillAssignmentRender=function(){return this.slotassign.GetRender()};SkillTreeCore.prototype.ReadAssignment=function(){this.slotassign.ReadAssignment()};var SkillCore=new SkillTreeCore,mouseX,mouseY;$(document).mousemove(function(e){window.mouseX=e.pageX;window.mouseY=e.pageY});
function SetToolTip(e){var d;e.mouseover(function(){var c=$(this).attr("insight");if(c){var a=window.SkillCore.GetSkill(c);if(c=a.GetCurrentLevelInfo()){var b=c.SkillDescription,e=c.SkillEffect;c=$("div#tooltip");var f=[];b&&(f.push("[Description]\n"),f.push(b));e&&(0!==f.length&&f.push("\n\n"),f.push("[Effect]\n"),f.push(e));$("div#tooltip .tooltipheader").text(a.GetName());0!==f?$("div#tooltip pre").text(f.join("")).show():$("div#tooltip pre").empty().hide();a={};d=$(".navbar.fixed-bottom").outerHeight(!0);
b=window.mouseY+10;b+c.outerHeight(!0)>$(document).height()-d?(a.bottom=d,a.top=""):(a.bottom="",a.top=b);b=window.mouseX+5;b+c.outerWidth(!0)>$(document).width()?(a.left="",a.right=0):(a.right="",a.left=b);c.css(a);c.stop(!1,!0).fadeIn("fast")}}}).mousemove(function(){var c=$("div#tooltip"),a={},b=window.mouseY+10;b+c.outerHeight(!0)>$(document).height()-d?(a.bottom=d,a.top=""):(a.bottom="",a.top=b);b=window.mouseX+5;b+c.outerWidth(!0)>$(document).width()?(a.left="",a.right=0):(a.right="",a.left=
b);c.css(a)}).mouseout(function(){$("div#tooltip").stop(!1,!0).fadeOut("fast")});return e}
function SetToolTipUp(e){var d;e.mouseover(function(){var c=$(this).attr("insight");if(c){c=window.SkillCore.GetSkill(c);var a=c.GetCurrentLevelInfo(),b=c.GetNextLevelInfo();c=$("div#tooltip");if(a||b){a=a.SkillEffect;var e="";b&&(e=b.SkillEffect);a||e?(b=[],a&&(b.push("[Current]\n"),b.push(a)),e&&(0!==b.length&&b.push("\n\n"),b.push("[After]\n"),b.push(e)),0!==b.length?$("div#tooltip pre").text(b.join("")).show():$("div#tooltip pre").empty().hide(),b={},d=$(".navbar.fixed-bottom").outerHeight(!0),
a=window.mouseY+10,a+c.outerHeight(!0)>$(document).height()-d?(b.bottom=d,b.top=""):(b.bottom="",b.top=a),a=window.mouseX+5,a+c.outerWidth(!0)>$(document).width()?(b.left="",b.right=0):(b.right="",b.left=a),c.css(b),c.stop(!1,!0).fadeIn("fast")):c.stop(!1,!0).fadeOut("fast")}}}).mousemove(function(){var c=$("div#tooltip"),a={},b=window.mouseY+10;b+c.outerHeight(!0)>$(document).height()-d?(a.bottom=d,a.top=""):(a.bottom="",a.top=b);b=window.mouseX+5;b+c.outerWidth(!0)>$(document).width()?(a.left="",
a.right=0):(a.right="",a.left=b);c.css(a)}).mouseout(function(){$("div#tooltip").stop(!1,!0).fadeOut("fast")});return e}
function SetToolTipDown(e){var d;e.mouseover(function(){var c=$(this).attr("insight");if(c){c=window.SkillCore.GetSkill(c);var a=c.GetCurrentLevelInfo(),b=c.GetPreviousLevelInfo();c=$("div#tooltip");if(a||b){a=a.SkillEffect;var e="";b&&(e=b.SkillEffect);a||e?(b=[],a&&(b.push("[Current]\n"),b.push(a)),e&&(0!==b.length&&b.push("\n\n"),b.push("[After]\n"),b.push(e)),0!==b.length?$("div#tooltip pre").text(b.join("")).show():$("div#tooltip pre").empty().hide(),b={},d=$(".navbar.fixed-bottom").outerHeight(!0),
a=window.mouseY+10,a+c.outerHeight(!0)>$(document).height()-d?(b.bottom=d,b.top=""):(b.bottom="",b.top=a),a=window.mouseX+5,a+c.outerWidth(!0)>$(document).width()?(b.left="",b.right=0):(b.right="",b.left=a),c.css(b),c.stop(!1,!0).fadeIn("fast")):c.stop(!1,!0).fadeOut("fast")}}}).mousemove(function(){var c=$("div#tooltip"),a={},b=window.mouseY+10;b+c.outerHeight(!0)>$(document).height()-d?(a.bottom=d,a.top=""):(a.bottom="",a.top=b);b=window.mouseX+5;b+c.outerWidth(!0)>$(document).width()?(a.left="",
a.right=0):(a.right="",a.left=b);c.css(a)}).mouseout(function(){$("div#tooltip").stop(!1,!0).fadeOut("fast")});return e}function ShowDangerDialog(e,d,c){e=new Bootstrap4ModalDialog($("#dialogs"),e,"Warning",Bootstrap4ModalDialog.ButtonsYesNoDanger);e.RegisterCallback(function(a,b){b?"function"===typeof d&&d():"function"===typeof c&&c()});e.Show()}
function ShowMessageDialog(e,d){var c=new Bootstrap4ModalDialog($("#dialogs"),e,"Notice");c.RegisterCallback(function(a,b){b&&"function"===typeof d&&d()});c.Show()}function ShowConfirmDialog(e,d,c){e=new Bootstrap4ModalDialog($("#dialogs"),e,"Double confirmation",Bootstrap4ModalDialog.ButtonsYesNo);e.RegisterCallback(function(a,b){b?"function"===typeof d&&d():"function"===typeof c&&c()});e.Show()}
function ShowSkillAssignment(e){window.SkillCore&&(new Bootstrap4ModalDialog($("#dialogs"),window.SkillCore.GetSkillAssignmentRender(),"Skill slot assignment",[{label:"Reset",cssClass:"btn btn-warning",action:function(d){window.ShowDangerDialog("Are you sure you want to reset all the slot assignments?",function(){window.SkillCore.ResetSlotAssignment()})}},{label:"Close",cssClass:"btn btn-default",action:function(d){d.Hide();"function"===typeof e&&e()}}])).Show()}
$(function(){$("#dialogs").hide().click(function(a){a.preventDefault();window.DialogManager.CloseForegroundDialog()});window.DialogManager.OnModalChanged(function(a){a?$("#dialogs").show():$("#dialogs").hide()});SetLoading($("body"));for(var e=$('<select id="selectLevelBox">').change(function(){window.SkillCore.SetLevel($(this).val())}),d=1;d<=window.c_maxlevel;d++)e.append($("<option>").val(d).text(d));$("#levelBoxtd").append(e);d=GetUrlParam("lv",60);60==d&&(d=GetUrlParam("level",60));isNaN(d)&&
(d=60);e.val(d);e.trigger("change");$('#charList a[href^="../'+GetCurrentFolderUrl()+'"]').remove();$("#copyURL").click(function(a){a.preventDefault();(a=window.SkillCore.GenerateLink())&&copyLink(a)});$("#copyURLshowassign").click(function(a){a.preventDefault();(a=window.SkillCore.GenerateLink(!0))&&copyLink(a)});$("#resetAllSkill").click(function(){ShowDangerDialog("Are you sure you want to unlearn all skills?",function(){window.SkillCore.UnlearnAllSkills()})});$("#slotassignment").click(function(){ShowSkillAssignment()});
var c=GetUrlParam("sa",null);window.SkillCore.ReadTree(function(a){if(a.Cover&&a.Cover.URL){var b=a.Cover.Position?a.Cover.Position:"side-right";$("#forbackground").append($("<img>").addClass(["image-bg-character",b]).attr("src",a.Cover.URL).imagesLoaded().always(function(a){a.elements.forEach(function(a,b,c){$(a).addClass("animated fadeIn").show()})}).hide())}},function(){RemoveLoading($("body"));window.SkillCore.ReadAssignment();"1"===c&&$("#slotassignment").click()})});